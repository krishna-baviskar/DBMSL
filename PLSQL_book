-- ✅ FULL PL/SQL PROGRAM (Single Code Block)

-- Create tables
CREATE TABLE Borrower (
    Roll_no NUMBER PRIMARY KEY,
    Name VARCHAR2(50),
    DateOfIssue DATE,
    NameOfBook VARCHAR2(50),
    Status CHAR(1)
);

CREATE TABLE Fine (
    Roll_no NUMBER,
    Date DATE,
    Amt NUMBER(10,2)
);

-- Insert sample data
INSERT INTO Borrower VALUES (101, 'Krishna', DATE '2025-10-10', 'DBMS', 'I');
INSERT INTO Borrower VALUES (102, 'Ravi', DATE '2025-11-01', 'CNS', 'I');
COMMIT;

-- PL/SQL Block
SET SERVEROUTPUT ON;
DECLARE
    v_roll_no      NUMBER;
    v_book_name    VARCHAR2(50);
    v_date_issue   DATE;
    v_days         NUMBER;
    v_fine_amt     NUMBER := 0;
BEGIN
    -- Accept input from user
    v_roll_no := &roll_no;
    v_book_name := '&book_name';

    -- Get date of issue
    SELECT DateOfIssue 
    INTO v_date_issue
    FROM Borrower
    WHERE Roll_no = v_roll_no AND NameOfBook = v_book_name;

    -- Calculate number of days since issue
    v_days := TRUNC(SYSDATE - v_date_issue);

    -- Fine calculation
    IF v_days BETWEEN 15 AND 30 THEN
        v_fine_amt := v_days * 5;
    ELSIF v_days > 30 THEN
        v_fine_amt := v_days * 50;
    ELSE
        v_fine_amt := 0;
    END IF;

    -- Update book status from Issued (I) to Returned (R)
    UPDATE Borrower
    SET Status = 'R'
    WHERE Roll_no = v_roll_no AND NameOfBook = v_book_name;

    DBMS_OUTPUT.PUT_LINE('Book returned successfully.');
    DBMS_OUTPUT.PUT_LINE('Total Days: ' || v_days);

    -- If fine applicable, insert into Fine table
    IF v_fine_amt > 0 THEN
        INSERT INTO Fine (Roll_no, Date, Amt)
        VALUES (v_roll_no, SYSDATE, v_fine_amt);
        DBMS_OUTPUT.PUT_LINE('Fine Recorded: ₹' || v_fine_amt);
    ELSE
        DBMS_OUTPUT.PUT_LINE('No fine applicable.');
    END IF;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('❌ No record found for given Roll No or Book Name.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('❌ Error: ' || SQLERRM);
END;
/
